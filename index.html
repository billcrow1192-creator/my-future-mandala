<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>深層分析曼荼羅チャート (9x9) | Secure Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&family=Orbitron:wght@400;700&display=swap');
        
        :root {
            --bg-dark: #020617;
            --accent-blue: #38bdf8;
            --glass: rgba(255, 255, 255, 0.03);
        }

        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            background-color: var(--bg-dark);
            margin: 0;
            overflow-x: hidden;
            color: #f8fafc;
        }

        /* 近未来的な背景アニメーション */
        .future-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: 
                radial-gradient(circle at 10% 20%, rgba(56, 189, 248, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(129, 140, 248, 0.1) 0%, transparent 40%);
        }

        .future-bg::after {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(56, 189, 248, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(56, 189, 248, 0.03) 1px, transparent 1px);
            background-size: 60px 60px;
            animation: moveGrid 30s linear infinite;
        }

        @keyframes moveGrid {
            from { background-position: 0 0; }
            to { background-position: 60px 60px; }
        }

        /* メインパネル */
        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 2rem;
        }

        .master-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            background: #ffffff; 
            padding: 12px;
            border-radius: 1rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
        
        .sub-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 2px;
            background-color: #f1f5f9;
            padding: 3px;
            border-radius: 6px;
        }
        
        .cell {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 3px;
            font-size: 0.55rem;
            line-height: 1.2;
            border-radius: 3px;
            word-break: break-all;
            transition: all 0.2s ease;
        }

        .cell-action { background-color: #ffffff; color: #1e293b; }
        .cell-sub-theme { background-color: #f0f9ff; color: #0369a1; font-weight: bold; }
        .cell-main-theme { background-color: #0f172a; color: #ffffff; font-weight: bold; border: 1.5px solid #38bdf8; }
        .cell-empty { border: 1px dashed #cbd5e1; color: transparent; }

        .loading-shimmer {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .status-badge {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(56, 189, 248, 0.1);
            color: var(--accent-blue);
            border: 1px solid rgba(56, 189, 248, 0.2);
        }

        @media (max-width: 640px) {
            .master-grid { gap: 4px; padding: 6px; }
            .cell { font-size: 0.4rem; padding: 1px; }
        }
    </style>
</head>
<body class="p-4 md:p-12">

    <div class="future-bg"></div>

    <div class="max-w-5xl mx-auto">
        <!-- Security Check Header -->
        <div class="flex justify-between items-center mb-8 px-4">
            <div id="keyStatus" class="status-badge flex items-center">
                <span id="statusDot" class="w-2 h-2 rounded-full bg-red-500 mr-2"></span>
                <span id="statusText">APIキー未設定</span>
            </div>
            <button onclick="configKey()" class="text-xs text-slate-400 hover:text-white transition-colors underline">
                鍵の設定を変更
            </button>
        </div>

        <header class="text-center mb-12">
            <h1 class="text-3xl md:text-5xl font-bold text-white mb-4 tracking-tight uppercase" style="font-family: 'Orbitron', sans-serif;">
                Analysis <span class="text-blue-400">Mandala</span> 9&times;9
            </h1>
            <p class="text-slate-400 text-base md:text-lg font-light italic">Deep insights structured by AI logic.</p>
        </header>

        <div class="glass-panel p-6 md:p-10 shadow-2xl">
            <!-- Theme Input -->
            <div class="flex flex-col md:flex-row gap-4 mb-10">
                <input type="text" id="coreTheme" 
                    class="flex-1 px-6 py-4 bg-slate-900/60 border border-slate-700 rounded-2xl text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500 outline-none transition-all shadow-inner"
                    placeholder="思考の核となるテーマを入力...">
                <button id="generateBtn" 
                    class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-10 rounded-2xl transition-all shadow-lg active:scale-95 whitespace-nowrap">
                    分析実行
                </button>
            </div>

            <!-- Chart Container -->
            <div id="captureArea" class="bg-slate-300/10 p-4 rounded-2xl mb-10">
                <div id="mandalaContainer" class="master-grid"></div>
            </div>

            <!-- Result Actions -->
            <div id="actionButtons" class="hidden flex justify-center gap-4">
                <button id="copyTextBtn" class="flex items-center px-8 py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-xl border border-slate-600 transition-all font-bold">
                    分析サマリーをコピー
                </button>
            </div>
        </div>

        <!-- Reflection Area -->
        <div id="reflectionArea" class="hidden mt-12 animate-fade-in">
            <div class="bg-slate-900/80 border border-blue-500/20 p-8 rounded-3xl shadow-2xl">
                <h3 class="text-xl font-bold mb-8 flex items-center text-blue-400 font-mono">
                    <span class="mr-3">◈</span> LOGICAL_WALL_HITTING
                </h3>
                <div class="grid md:grid-cols-2 gap-10">
                    <div>
                        <h4 class="text-xs font-bold text-blue-300 mb-4 uppercase tracking-[0.2em] opacity-80">論理的な矛盾とリスク</h4>
                        <ul id="contradictionList" class="space-y-4 text-slate-300 text-sm leading-relaxed"></ul>
                    </div>
                    <div>
                        <h4 class="text-xs font-bold text-blue-300 mb-4 uppercase tracking-[0.3em] opacity-80">多角的な問いかけ</h4>
                        <ul id="questionList" class="space-y-4 text-slate-300 text-sm leading-relaxed"></ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="errorMessage" class="hidden mt-6 p-4 bg-red-900/20 border border-red-500/50 text-red-400 rounded-2xl text-center"></div>

        <footer class="mt-20 pb-10 text-center text-slate-600 text-[10px] font-mono tracking-widest uppercase">
            System Phase 9.0 // Data Confidentiality Priority
        </footer>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-8 py-3 rounded-full shadow-2xl opacity-0 transition-opacity z-50">
        Copied to clipboard.
    </div>

    <script>
        // APIキーの管理（Vercel等の環境変数を意識したセキュアな構造）
        function configKey() {
            const key = prompt("Google AI Studio (Gemini) のAPIキーを入力してください。\nこのキーはあなたのブラウザのみに安全に保存されます。");
            if (key && key.length > 10) {
                localStorage.setItem("VAULT_KEY", key.trim());
                updateStatus();
                alert("認証に成功しました。");
                location.reload();
            }
        }

        function updateStatus() {
            const key = localStorage.getItem("VAULT_KEY");
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            if (key) {
                dot.className = "w-2 h-2 rounded-full bg-green-500 mr-2 shadow-[0_0_8px_rgba(34,197,94,0.6)]";
                text.textContent = "API READY";
            }
        }
        updateStatus();

        const generateBtn = document.getElementById('generateBtn');
        const coreInput = document.getElementById('coreTheme');
        const mandalaContainer = document.getElementById('mandalaContainer');
        const reflectionArea = document.getElementById('reflectionArea');
        const actionButtons = document.getElementById('actionButtons');
        const copyTextBtn = document.getElementById('copyTextBtn');
        const contradictionList = document.getElementById('contradictionList');
        const questionList = document.getElementById('questionList');
        const errorMessage = document.getElementById('errorMessage');

        function initGrid() {
            mandalaContainer.innerHTML = '';
            for (let b = 0; b < 9; b++) {
                const subGrid = document.createElement('div');
                subGrid.className = 'sub-grid';
                for (let c = 0; c < 9; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell cell-empty';
                    cell.id = `block-${b}-cell-${c}`;
                    subGrid.appendChild(cell);
                }
                mandalaContainer.appendChild(subGrid);
            }
        }
        initGrid();

        async function analyzeWithAI(prompt) {
            const key = localStorage.getItem("VAULT_KEY");
            if (!key) throw new Error("APIキーが設定されていません。右上の設定から入力してください。");

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            structure: { type: "ARRAY", items: { type: "OBJECT", properties: { subTheme: { type: "STRING" }, actions: { type: "ARRAY", items: { type: "STRING" }, minItems: 8, maxItems: 8 } }, required: ["subTheme", "actions"] }, minItems: 8, maxItems: 8 },
                            contradictions: { type: "ARRAY", items: { type: "STRING" } },
                            questions: { type: "ARRAY", items: { type: "STRING" } }
                        },
                        required: ["structure", "contradictions", "questions"]
                    }
                }
            };

            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error("APIキーが無効、または制限に達しています。");
            const data = await response.json();
            return JSON.parse(data.candidates[0].content.parts[0].text);
        }

        generateBtn.addEventListener('click', async () => {
            const theme = coreInput.value.trim();
            if (!theme) return;
            errorMessage.classList.add('hidden');
            reflectionArea.classList.add('hidden');
            generateBtn.disabled = true;
            generateBtn.textContent = "ANALYZING...";
            document.querySelectorAll('.cell').forEach(c => { c.className = 'cell loading-shimmer'; c.textContent = ''; });

            try {
                const result = await analyzeWithAI(`テーマ: ${theme}\nこのテーマを9x9の曼荼羅チャートで深掘りしてください。各要素は日本語で作成してください。全体の矛盾3点と問いかけ3点も作成してください。`);
                
                const blockMapping = [0, 1, 2, 3, 5, 6, 7, 8];
                const mainCells = Array.from({length: 9}, (_, i) => document.getElementById(`block-4-cell-${i}`));
                mainCells[4].textContent = theme;
                mainCells[4].className = 'cell cell-main-theme';

                result.structure.forEach((item, idx) => {
                    const cellIdx = idx < 4 ? idx : idx + 1;
                    mainCells[cellIdx].textContent = item.subTheme;
                    mainCells[cellIdx].className = 'cell cell-sub-theme';
                    
                    const subBlockIdx = blockMapping[idx];
                    const subCells = Array.from({length: 9}, (_, i) => document.getElementById(`block-${subBlockIdx}-cell-${i}`));
                    subCells[4].textContent = item.subTheme;
                    subCells[4].className = 'cell cell-sub-theme text-[0.45rem]';
                    item.actions.forEach((act, aIdx) => {
                        const aCellIdx = aIdx < 4 ? aIdx : aIdx + 1;
                        subCells[aCellIdx].textContent = act;
                        subCells[aCellIdx].className = 'cell cell-action';
                    });
                });

                contradictionList.innerHTML = result.contradictions.map(c => `<li class="flex"><span class="text-blue-500 mr-3">!</span><span>${c}</span></li>`).join('');
                questionList.innerHTML = result.questions.map(q => `<li class="flex"><span class="text-blue-400 mr-3">?</span><span>${q}</span></li>`).join('');
                reflectionArea.classList.remove('hidden');
                actionButtons.classList.remove('hidden');

            } catch (err) {
                errorMessage.textContent = err.message;
                errorMessage.classList.remove('hidden');
                initGrid();
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = "分析実行";
            }
        });

        copyTextBtn.addEventListener('click', () => {
            const text = `【深層分析曼荼羅】テーマ：${coreInput.value}\nAIによる多角的な視点から、思考の解像度を向上。`;
            const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
            const toast = document.getElementById('toast'); toast.style.opacity = '1'; setTimeout(() => toast.style.opacity = '0', 2000);
        });
    </script>
</body>
</html>