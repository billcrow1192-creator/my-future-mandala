<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>深層分析曼荼羅チャート (9x9) | Future Insight</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&family=Orbitron:wght@400;700&display=swap');
        
        :root {
            --bg-dark: #020617;
            --accent-blue: #38bdf8;
            --accent-purple: #818cf8;
        }

        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            background-color: var(--bg-dark);
            margin: 0;
            overflow-x: hidden;
            color: #f8fafc;
        }

        /* 近未来的な動的背景 */
        .future-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(circle at 20% 30%, rgba(56, 189, 248, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(129, 140, 248, 0.15) 0%, transparent 40%);
        }

        .future-bg::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(56, 189, 248, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(56, 189, 248, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            perspective: 1000px;
            transform: rotateX(60deg) translateY(-100px);
            transform-origin: top;
            animation: gridMove 20s linear infinite;
        }

        @keyframes gridMove {
            from { background-position: 0 0; }
            to { background-position: 0 500px; }
        }

        /* チャートエリア（可読性のために背景を保護） */
        .main-container {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 32px;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .master-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 12px;
            width: 100%;
            background: #ffffff; 
            padding: 16px;
            border-radius: 20px;
        }
        
        .sub-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 3px;
            background-color: #f1f5f9;
            padding: 4px;
            border-radius: 8px;
        }
        
        .cell {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 4px;
            font-size: 0.6rem;
            line-height: 1.25;
            border-radius: 4px;
            overflow: hidden;
            word-break: break-all;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .cell-action { background-color: #ffffff; color: #334155; }
        .cell-sub-theme { background-color: #eff6ff; color: #1e40af; font-weight: bold; }
        .cell-main-theme { background-color: #0f172a; color: #ffffff; font-weight: bold; font-size: 0.75rem; border: 2px solid #38bdf8; }
        .cell-empty { background-color: transparent; color: #cbd5e1; border: 1px dashed #cbd5e1; }

        .loading-shimmer {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .btn-future {
            background: linear-gradient(90deg, #38bdf8, #818cf8);
            color: white;
            transition: all 0.3s;
        }

        .btn-future:hover {
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.5);
            transform: translateY(-2px);
        }

        .future-title {
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 0.1em;
            text-shadow: 0 0 10px rgba(56, 189, 248, 0.5);
        }

        @media (max-width: 768px) {
            .master-grid { gap: 6px; padding: 8px; }
            .cell { font-size: 0.4rem; padding: 1px; }
        }
    </style>
</head>
<body>

    <div class="future-bg"></div>

    <div class="max-w-6xl mx-auto px-4 py-12">
        <header class="text-center mb-12">
            <h1 class="text-3xl md:text-5xl font-bold future-title text-white mb-4">
                DEEP ANALYSIS MANDALA <span class="text-blue-400">9&times;9</span>
            </h1>
            <p class="text-slate-400 text-lg">深層分析曼荼羅チャート</p>
        </header>

        <div class="main-container">
            <div class="flex flex-col md:flex-row gap-4 mb-8">
                <input type="text" id="coreTheme" 
                    class="flex-1 px-6 py-4 bg-slate-900/50 border border-slate-700 rounded-2xl text-white placeholder-slate-500 focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                    placeholder="核となるテーマを入力...">
                <button id="generateBtn" 
                    class="btn-future font-bold py-4 px-10 rounded-2xl whitespace-nowrap">
                    分析を開始
                </button>
            </div>

            <div id="captureArea" class="bg-slate-200/20 p-4 rounded-2xl mb-8">
                <div id="mandalaContainer" class="master-grid"></div>
            </div>

            <div id="actionButtons" class="hidden flex flex-wrap gap-4 justify-center">
                <button id="copyTextBtn" class="flex items-center px-8 py-3 bg-slate-800 text-white rounded-xl hover:bg-slate-700 transition-all border border-slate-700">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                    内容をコピーしてSNSで共有
                </button>
            </div>
        </div>

        <div id="reflectionArea" class="hidden mt-12">
            <div class="bg-slate-900 border border-blue-500/30 p-8 rounded-3xl shadow-2xl">
                <h3 class="text-xl font-bold mb-8 flex items-center text-blue-400 font-mono tracking-tighter">
                    <span class="mr-3 text-2xl">CORE_INSIGHT_LOG:</span>
                    <span class="text-xs font-normal px-2 py-1 bg-blue-500/10 rounded">SYSTEM_CHECK_OK</span>
                </h3>
                <div class="grid md:grid-cols-2 gap-10">
                    <div>
                        <h4 class="text-xs font-bold text-blue-300 mb-4 uppercase tracking-[0.3em] border-b border-blue-500/20 pb-2">Logical Discrepancy</h4>
                        <ul id="contradictionList" class="space-y-4 text-slate-300 text-sm leading-relaxed"></ul>
                    </div>
                    <div>
                        <h4 class="text-xs font-bold text-blue-300 mb-4 uppercase tracking-[0.3em] border-b border-blue-500/20 pb-2">Strategic Inquiry</h4>
                        <ul id="questionList" class="space-y-4 text-slate-300 text-sm leading-relaxed"></ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="errorMessage" class="hidden mt-6 p-4 bg-red-900/20 border border-red-500/50 text-red-400 rounded-2xl text-center"></div>

        <footer class="mt-20 pb-10 text-center text-slate-500 text-xs font-mono uppercase tracking-widest">
            &copy; 2026 DEEP ANALYSIS SYSTEM // PHASE-9 ACTIVE
        </footer>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-8 py-3 rounded-full shadow-2xl opacity-0 transition-opacity pointer-events-none z-50">
        Copied to clipboard.
    </div>

    <script>
        const apiKey = "";
        const generateBtn = document.getElementById('generateBtn');
        const coreInput = document.getElementById('coreTheme');
        const mandalaContainer = document.getElementById('mandalaContainer');
        const reflectionArea = document.getElementById('reflectionArea');
        const actionButtons = document.getElementById('actionButtons');
        const copyTextBtn = document.getElementById('copyTextBtn');
        const contradictionList = document.getElementById('contradictionList');
        const questionList = document.getElementById('questionList');
        const errorMessage = document.getElementById('errorMessage');
        const toast = document.getElementById('toast');

        let lastResult = null;

        function initGrid() {
            mandalaContainer.innerHTML = '';
            for (let b = 0; b < 9; b++) {
                const subGrid = document.createElement('div');
                subGrid.className = 'sub-grid';
                for (let c = 0; c < 9; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell cell-empty';
                    cell.id = `block-${b}-cell-${c}`;
                    subGrid.appendChild(cell);
                }
                mandalaContainer.appendChild(subGrid);
            }
        }
        initGrid();

        async function callGemini(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            structure: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        subTheme: { type: "STRING" },
                                        actions: { type: "ARRAY", items: { type: "STRING" }, minItems: 8, maxItems: 8 }
                                    },
                                    required: ["subTheme", "actions"]
                                },
                                minItems: 8, maxItems: 8
                            },
                            contradictions: { type: "ARRAY", items: { type: "STRING" } },
                            questions: { type: "ARRAY", items: { type: "STRING" } }
                        },
                        required: ["structure", "contradictions", "questions"]
                    }
                }
            };

            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error('API Request Failed');
                    const data = await response.json();
                    return JSON.parse(data.candidates[0].content.parts[0].text);
                } catch (e) {
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
            }
            throw new Error('分析プロセスにエラーが発生しました。');
        }

        generateBtn.addEventListener('click', async () => {
            const theme = coreInput.value.trim();
            if (!theme) return;

            errorMessage.classList.add('hidden');
            reflectionArea.classList.add('hidden');
            actionButtons.classList.add('hidden');
            generateBtn.disabled = true;
            generateBtn.textContent = "ANALYZING...";

            document.querySelectorAll('.cell').forEach(c => {
                c.className = 'cell loading-shimmer';
                c.textContent = '';
            });

            const prompt = `あなたは高度な戦略コンサルタントです。テーマ「${theme}」を9x9曼荼羅で分解してください。各サブテーマに対し具体的アクションを提示し、全体の矛盾3点と、本質的な問いかけ3点を作成してください。`;

            try {
                const data = await callGemini(prompt);
                lastResult = { theme, ...data };
                
                const blockMapping = [0, 1, 2, 3, 5, 6, 7, 8];
                const centerBlockIdx = 4;
                const mainBlockCells = Array.from({length: 9}, (_, i) => document.getElementById(`block-${centerBlockIdx}-cell-${i}`));
                
                mainBlockCells[4].textContent = theme;
                mainBlockCells[4].className = 'cell cell-main-theme';
                
                data.structure.forEach((item, idx) => {
                    const cellIdx = idx < 4 ? idx : idx + 1;
                    mainBlockCells[cellIdx].textContent = item.subTheme;
                    mainBlockCells[cellIdx].className = 'cell cell-sub-theme';

                    const sBlockIdx = blockMapping[idx];
                    const sCells = Array.from({length: 9}, (_, i) => document.getElementById(`block-${sBlockIdx}-cell-${i}`));
                    sCells[4].textContent = item.subTheme;
                    sCells[4].className = 'cell cell-sub-theme text-[0.5rem]';
                    
                    item.actions.forEach((action, aIdx) => {
                        const sCellIdx = aIdx < 4 ? aIdx : aIdx + 1;
                        sCells[sCellIdx].textContent = action;
                        sCells[sCellIdx].className = 'cell cell-action';
                    });
                });

                contradictionList.innerHTML = data.contradictions.map(c => `<li class="flex"><span class="text-blue-500 mr-3">▶</span><span>${c}</span></li>`).join('');
                questionList.innerHTML = data.questions.map(q => `<li class="flex"><span class="text-blue-500 mr-3">▶</span><span>${q}</span></li>`).join('');
                
                reflectionArea.classList.remove('hidden');
                actionButtons.classList.remove('hidden');

            } catch (err) {
                errorMessage.textContent = err.message;
                errorMessage.classList.remove('hidden');
                initGrid();
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = "分析を開始";
            }
        });

        copyTextBtn.addEventListener('click', () => {
            if (!lastResult) return;
            let text = `【深層分析曼荼羅チャート（9×9）】\nテーマ：${lastResult.theme}\n\n`;
            lastResult.structure.forEach((s, i) => {
                text += `${i + 1}. ${s.subTheme}：${s.actions.slice(0, 2).join(', ')} ...\n`;
            });
            text += `\n#深層分析曼荼羅 #AI分析`;

            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);

            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 2000);
        });
    </script>
</body>
</html>