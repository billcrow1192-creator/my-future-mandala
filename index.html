<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Core Mandala | Strategic Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&family=Inter:wght@400;700&family=Orbitron:wght@500&display=swap');
        
        :root {
            --bg: #030712;
            --accent: #38bdf8;
            --border: rgba(255, 255, 255, 0.1);
        }

        body { 
            font-family: 'Inter', 'Noto Sans JP', sans-serif; 
            background-color: var(--bg);
            color: #f3f4f6;
            margin: 0;
            overflow-x: hidden;
        }

        .grid-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: 
                linear-gradient(rgba(56, 189, 248, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(56, 189, 248, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: move 20s linear infinite;
        }
        @keyframes move { from { background-position: 0 0; } to { background-position: 0 500px; } }

        .glass {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 1.5rem;
        }

        .master-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            background: rgba(255, 255, 255, 0.05);
            padding: 16px;
            border-radius: 12px;
        }

        .sub-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px;
            border-radius: 6px;
        }

        .cell {
            aspect-ratio: 1/1;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.65rem;
            padding: 4px;
            color: #1e293b;
            line-height: 1.2;
            border-radius: 2px;
            word-break: break-all;
            overflow: hidden;
        }

        .cell-main { background: #0ea5e9; color: white; font-weight: bold; border: 2px solid #38bdf8; }
        .cell-sub { background: #1e293b; color: #38bdf8; font-weight: bold; border: 1px solid rgba(56, 189, 248, 0.3); }
        .cell-action { background: #ffffff; color: #1e293b; }
        .cell-empty { background: rgba(255, 255, 255, 0.03); color: transparent; border: 1px dashed rgba(255, 255, 255, 0.1); }

        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9, #6366f1);
            transition: all 0.3s;
        }
        .btn-primary:hover:not(:disabled) {
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.4);
            transform: translateY(-2px);
        }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        .thinking-log {
            font-family: monospace;
            font-size: 0.75rem;
            color: var(--accent);
        }

        @media (max-width: 768px) {
            .master-grid { gap: 6px; padding: 8px; }
            .cell { font-size: 0.4rem; padding: 1px; }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="grid-bg"></div>

    <!-- Header / Auth Info -->
    <div class="w-full bg-slate-900/90 border-b border-white/10 p-3 sticky top-0 z-50 backdrop-blur-md">
        <div class="max-w-6xl mx-auto flex justify-between items-center text-[10px] uppercase tracking-widest font-bold">
            <div id="authStatus" class="flex items-center gap-2">
                <span id="statusDot" class="w-2 h-2 rounded-full bg-red-500"></span>
                <span id="statusText">Unauthorized (API Key Required)</span>
            </div>
            <button onclick="configureAuth()" class="text-blue-400 hover:text-white transition-colors">
                [ AUTH_SETTING ]
            </button>
        </div>
    </div>

    <main class="max-w-5xl mx-auto px-4 py-12">
        <header class="text-center mb-16">
            <h1 class="text-4xl md:text-6xl font-black mb-4 tracking-tighter" style="font-family: 'Orbitron', sans-serif;">
                CORE_<span class="text-blue-500">MANDALA</span>
            </h1>
            <p class="text-slate-400 font-light tracking-[0.3em] uppercase text-xs">
                Deep Strategic Analysis System
            </p>
        </header>

        <div class="glass p-6 md:p-8 shadow-2xl">
            <div class="flex flex-col md:flex-row gap-4 mb-8">
                <input type="text" id="coreTheme" 
                    class="flex-1 px-6 py-4 bg-black/40 border border-white/10 rounded-xl text-white placeholder-slate-600 outline-none focus:border-blue-500 transition-all"
                    placeholder="思考を深めたいテーマを入力...">
                <button id="generateBtn" 
                    class="btn-primary px-10 py-4 rounded-xl font-bold uppercase tracking-widest text-sm">
                    Analyze
                </button>
            </div>

            <!-- Loading State -->
            <div id="thinking" class="hidden mb-6 thinking-log text-center space-y-2">
                <div class="animate-pulse">> INITIALIZING NEURAL NETWORK...</div>
                <div id="loadingStep" class="text-[10px] opacity-60">Connecting to Gemini...</div>
            </div>

            <!-- Result Grid -->
            <div class="p-2 bg-slate-900/50 rounded-xl border border-white/5 mb-8 overflow-x-auto">
                <div id="mandalaContainer" class="master-grid min-w-[600px] md:min-w-full">
                    <!-- Initial Placeholder -->
                </div>
            </div>

            <!-- Copy Button -->
            <div id="actionArea" class="hidden flex justify-center">
                <button id="copyBtn" class="px-8 py-3 bg-white/5 border border-white/20 rounded-full text-xs hover:bg-white/10 transition-all flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                    Copy Logic Log
                </button>
            </div>
        </div>

        <!-- Insights -->
        <div id="insightArea" class="hidden mt-12 grid md:grid-cols-2 gap-8">
            <div class="glass p-6 border-l-4 border-red-500/50">
                <h3 class="text-xs font-bold text-red-400 mb-4 uppercase tracking-widest flex items-center gap-2">
                    <span>⚠</span> Logical Contradictions
                </h3>
                <ul id="contradictions" class="space-y-3 text-sm text-slate-300"></ul>
            </div>
            <div class="glass p-6 border-l-4 border-blue-500/50">
                <h3 class="text-xs font-bold text-blue-400 mb-4 uppercase tracking-widest flex items-center gap-2">
                    <span>?</span> Critical Inquiries
                </h3>
                <ul id="questions" class="space-y-3 text-sm text-slate-300"></ul>
            </div>
        </div>
    </main>

    <footer class="mt-20 py-10 text-center opacity-30 text-[10px] tracking-[0.5em] uppercase">
        AI Capability Demonstration // Core Mandala Build 2.0
    </footer>

    <script>
        const configKey = "CORE_V1_KEY";
        const apiKey = ""; // Should stay empty, we use localStorage

        const updateStatus = () => {
            const hasKey = !!localStorage.getItem(configKey);
            document.getElementById('statusDot').className = hasKey ? "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_#22c55e]" : "w-2 h-2 rounded-full bg-red-500";
            document.getElementById('statusText').textContent = hasKey ? "Authorized" : "Unauthorized (Please set API Key)";
        };

        function configureAuth() {
            const key = prompt("Please enter your Gemini API Key:");
            if (key) {
                localStorage.setItem(configKey, key.trim());
                updateStatus();
                location.reload();
            }
        }

        function initPlaceholder() {
            const container = document.getElementById('mandalaContainer');
            container.innerHTML = '';
            for(let i=0; i<9; i++) {
                const sub = document.createElement('div');
                sub.className = 'sub-grid';
                for(let j=0; j<9; j++) {
                    const c = document.createElement('div');
                    c.className = 'cell cell-empty';
                    sub.appendChild(c);
                }
                container.appendChild(sub);
            }
        }

        // API Call with Exponential Backoff
        async function fetchGemini(prompt, key) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            structure: { 
                                type: "ARRAY", 
                                items: { 
                                    type: "OBJECT", 
                                    properties: { 
                                        subTheme: { type: "STRING" }, 
                                        actions: { type: "ARRAY", items: { type: "STRING" } } 
                                    } 
                                } 
                            },
                            contradictions: { type: "ARRAY", items: { type: "STRING" } },
                            questions: { type: "ARRAY", items: { type: "STRING" } }
                        }
                    }
                }
            };

            for (let n = 0; n < 5; n++) {
                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const data = await res.json();
                    return JSON.parse(data.candidates[0].content.parts[0].text);
                } catch (e) {
                    if (n === 4) throw e;
                    await new Promise(r => setTimeout(r, Math.pow(2, n) * 1000));
                }
            }
        }

        const btn = document.getElementById('generateBtn');
        btn.addEventListener('click', async () => {
            const theme = document.getElementById('coreTheme').value.trim();
            const key = localStorage.getItem(configKey);
            
            if (!key) return configureAuth();
            if (!theme) return alert("分析するテーマを入力してください。");

            btn.disabled = true;
            document.getElementById('thinking').classList.remove('hidden');
            document.getElementById('loadingStep').textContent = "曼荼羅構造を生成中...";

            try {
                const promptText = `
                    テーマ: "${theme}"
                    このテーマを9x9の曼荼羅チャートで分解してください。
                    中心（5番目の要素）に "${theme}" を置き、その周囲8つのサブテーマを決定。
                    さらに各サブテーマに対し、周囲8つの具体的なアクション（計64個）を提案してください。
                    最後に、この論理構造に含まれる潜在的な矛盾点3つと、本質的な問い3つも抽出してください。
                `;
                
                const result = await fetchGemini(promptText, key);
                render(theme, result);
            } catch (e) {
                alert("APIエラーが発生しました。キーが無効か、回数制限の可能性があります。");
                console.error(e);
            } finally {
                btn.disabled = false;
                document.getElementById('thinking').classList.add('hidden');
            }
        });

        function render(theme, result) {
            const container = document.getElementById('mandalaContainer');
            container.innerHTML = '';
            
            const blocks = Array.from({length: 9}, () => document.createElement('div'));
            blocks.forEach(b => b.className = 'sub-grid');

            // SubThemes extraction
            const subThemes = result.structure.map(s => s.subTheme);
            
            // Center Block (4)
            const mainBlock = blocks[4];
            for(let i=0; i<9; i++) {
                const c = document.createElement('div');
                if(i === 4) {
                    c.className = 'cell cell-main';
                    c.textContent = theme;
                } else {
                    const sIdx = i < 4 ? i : i - 1;
                    c.className = 'cell cell-sub';
                    c.textContent = subThemes[sIdx] || "...";
                }
                mainBlock.appendChild(c);
            }

            // Outer Blocks
            const map = [0, 1, 2, 3, 5, 6, 7, 8];
            result.structure.forEach((s, idx) => {
                if(idx >= 8) return;
                const block = blocks[map[idx]];
                for(let i=0; i<9; i++) {
                    const c = document.createElement('div');
                    if(i === 4) {
                        c.className = 'cell cell-sub';
                        c.textContent = s.subTheme;
                    } else {
                        const aIdx = i < 4 ? i : i - 1;
                        c.className = 'cell cell-action';
                        c.textContent = s.actions[aIdx] || "-";
                    }
                    block.appendChild(c);
                }
            });

            blocks.forEach(b => container.appendChild(b));

            // Insights
            document.getElementById('contradictions').innerHTML = result.contradictions.map(c => `<li>${c}</li>`).join('');
            document.getElementById('questions').innerHTML = result.questions.map(q => `<li>${q}</li>`).join('');
            
            document.getElementById('insightArea').classList.remove('hidden');
            document.getElementById('actionArea').classList.remove('hidden');

            // Copy logic
            document.getElementById('copyBtn').onclick = () => {
                const log = `Theme: ${theme}\n\nContradictions:\n${result.contradictions.join('\n')}\n\nQuestions:\n${result.questions.join('\n')}`;
                const el = document.createElement('textarea');
                el.value = log;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                alert("Copied to clipboard!");
            };
        }

        updateStatus();
        initPlaceholder();
    </script>
</body>
</html>